// JavaScript Document

function loadContent(n) {
    var t, i;
    n.siblings().removeClass("active");
    n.addClass("active");
    t = n.parents(".row").find("[data-toggle='collapse']");
    t.html("<div class=\"d-flex justify-content-between\">"+n.html()+"<i class=\"fas fa-caret-down lead\"></i></div>");
    i = n.parents(".row").find(".equipment-panel");
    $.ajax({
        url: n.data("link"),
        type: "GET",
        success: function(n) {
            i.html(n);
        },
        error: function() {
            i.html("Sorry, content could not be loaded");
        }
    });
}

function checkICMail(mail) {
	/* IF WE ONLY WANT IC mails
	var mailParts = mail.split("@");
	if(mailParts.length >= 2) {
		return (mailParts[1] == "ic.ac.uk") || (mailParts[1] == "imperial.ac.uk");
	}
	return false;*/
	var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
  return emailReg.test(mail);
}

function getURLParameter(sParam) {
  var sPageURL = window.location.search.substring(1);
	var sURLVariables = sPageURL.split('&');
	for (var i = 0; i < sURLVariables.length; i++)
	{
		var sParameterName = sURLVariables[i].split('=');
		if (sParameterName[0] == sParam)
		{
			return sParameterName[1];
		}
	}
}

$(function(){

	if($(".equipment-list").length) {
		loadContent($(".equipment-tab.active"));
	}
	
	$(".equipment-list").on("click", "li", function() {
  	loadContent($(this));
  	$("#equipment-collapse").collapse('toggle');
  });
  
	$('#'+getURLParameter("service")).attr("selected",true);
  
  $(".submit-btn").click(function() {
  	if(checkICMail($("#mailForm").val())){
  		if($("#nameForm").val() &&
  		   $("#mailForm").val() &&
  		   $("#serviceForm").val() &&
  		   $("#descriptionForm").val()) {
  			var poolId = 'us-east-1:73f8fa6e-a91a-49e4-a024-f38ddbb16336'; 

			AWS.config.update({
  			credentials: new AWS.CognitoIdentityCredentials({
    			IdentityPoolId: poolId
  			}),
  			region: 'us-east-1'
			});

			var lambda = new AWS.Lambda({region: 'us-east-1', apiVersion: '2015-03-31'});
			var pullParams = {
  			FunctionName : 'test3',
  			InvocationType : 'RequestResponse',
  			LogType : 'None',
  			Payload: JSON.stringify({"newsletterEmail":"","name":$("#nameForm").val(),"email":$("#mailForm").val(),"service":$("#serviceForm").val(),"desc":$("#descriptionForm").val()}) 
			};

			lambda.invoke(pullParams, function(error, data) {
				console.log(error,data)
  			if (error) {
  				alert("Something went wrong! Please address your request directly to: icrproduction@ic.ac.uk.");
 				}
 				else {
  				$("#nameForm").val('');
  				$("#mailForm").val('');
  				$("#descriptionForm").val('');
    			$(".thanks-msg").collapse();
 				}
			});
  		} else {
  			$('#alertAllInputsModal').modal();
  		}
  	} else {
  		$('#alertICMailModal').modal();
  	}
  });
  
  $(".btn-newsletter").click(function() {
  	if(checkICMail($("#inputNewsletter").val())){
  		var poolId = 'us-east-1:73f8fa6e-a91a-49e4-a024-f38ddbb16336'; 

			AWS.config.update({
  			credentials: new AWS.CognitoIdentityCredentials({
    			IdentityPoolId: poolId
  			}),
  			region: 'us-east-1'
			});

			var lambda = new AWS.Lambda({region: 'us-east-1', apiVersion: '2015-03-31'});
			var pullParams = {
  			FunctionName : 'test3',
  			InvocationType : 'RequestResponse',
  			LogType : 'None',
  			Payload: JSON.stringify({"newsletterEmail":$("#inputNewsletter").val(),"name":"","email":"","service":"","desc":""}) 
			};

			lambda.invoke(pullParams, function(error, data) {
				console.log(error,data)
  			if (error) {
  				alert("Something went wrong! Please address your request directly to: icrproduction@ic.ac.uk.");
 				}
 				else {
 					$(".footer-mail").addClass('d-none');
    			$(".btn-newsletter").addClass('d-none');
    			$(".thanks-newsletter").removeClass('d-none');
 				}
			});
  	} else {
  		$('#alertICMailModal').modal();
  	}
  });
  
  $(".btn-newsletter-page").click(function() {
  	if(checkICMail($("#inputNewsletterPage").val())){
  		var poolId = 'us-east-1:73f8fa6e-a91a-49e4-a024-f38ddbb16336'; 

			AWS.config.update({
  			credentials: new AWS.CognitoIdentityCredentials({
    			IdentityPoolId: poolId
  			}),
  			region: 'us-east-1'
			});

			var lambda = new AWS.Lambda({region: 'us-east-1', apiVersion: '2015-03-31'});
			var pullParams = {
  			FunctionName : 'test3',
  			InvocationType : 'RequestResponse',
  			LogType : 'None',
  			Payload: JSON.stringify({"newsletterEmail":$("#inputNewsletterPage").val(),"name":"","email":"","service":"","desc":""}) 
			};

			lambda.invoke(pullParams, function(error, data) {
				console.log(error,data)
  			if (error) {
  				alert("Something went wrong! Please address your request directly to: icrproduction@ic.ac.uk.");
 				} else {
    			$("#inputNewsletterPage").addClass('d-none');
    			$(".btn-newsletter-page").addClass('d-none');
    			$(".thanks-newsletter-page").removeClass('d-none');
 				}
			});
  	} else {
  		$('#alertICMailModal').modal();
  	}
  });
});