// JavaScript Document

function loadContent(n) {
    var t, i;
    n.siblings().removeClass("active");
    n.addClass("active");
    t = n.parents(".row").find("[data-toggle='collapse']");
    t.html("<div class=\"d-flex justify-content-between\">"+n.html()+"<i class=\"fas fa-caret-down lead\"></i></div>");
    i = n.parents(".row").find(".equipment-panel");
    $.ajax({
        url: n.data("link"),
        type: "GET",
        success: function(n) {
            i.html(n);
        },
        error: function() {
            i.html("Sorry, content could not be loaded");
        }
    });
}

function checkICMail(mail) {
	/* IF WE ONLY WANT IC mails
	var mailParts = mail.split("@");
	if(mailParts.length >= 2) {
		return (mailParts[1] == "ic.ac.uk") || (mailParts[1] == "imperial.ac.uk");
	}
	return false;*/
	var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
  return emailReg.test(mail);
}

function getURLParameter(sParam) {
  var sPageURL = window.location.search.substring(1);
	var sURLVariables = sPageURL.split('&');
	for (var i = 0; i < sURLVariables.length; i++)
	{
		var sParameterName = sURLVariables[i].split('=');
		if (sParameterName[0] == sParam)
		{
			return sParameterName[1];
		}
	}
}

$(function(){

	if($(".equipment-list").length) {
		loadContent($(".equipment-tab.active"));
	}
	
	$(".equipment-list").on("click", "li", function() {
  	loadContent($(this));
  	$("#equipment-collapse").collapse('toggle');
  });
  
	$('#'+getURLParameter("service")).attr("selected",true);
  
  $(".submit-btn").click(function() {
  	if(checkICMail($("#mailForm").val())){
  		if($("#nameForm").val() &&
  		   $("#mailForm").val() &&
  		   $("#serviceForm").val() &&
  		   $("#descriptionForm").val()) {
  			$.post("https://clayish-airfields.000webhostapp.com/contact.php", // TODO: Change link to server
  			{
   				name: $("#nameForm").val(),
   				mail: $("#mailForm").val(),
   				service: $("#serviceForm").val(),
   				description: $("#descriptionForm").val()
  			},
  			function(data, status){
  				$("#nameForm").val('');
  				$("#mailForm").val('');
  				$("#descriptionForm").val('');
    			$(".thanks-msg").collapse();
  			}).fail(function(error, status){
  				alert("Something went wrong!");
  			});
  		} else {
  			$('#alertAllInputsModal').modal();
  		}
  	} else {
  		$('#alertICMailModal').modal();
  	}
  });
  
  $(".btn-newsletter").click(function() {
  	if(checkICMail($("#inputNewsletter").val())){
  		$.post("https://clayish-airfields.000webhostapp.com/newsletter.php", // TODO: Change link to server
  		{
   			mail: $("#inputNewsletter").val()
  		},
  		function(data, status){
    		$(".footer-mail").addClass('d-none');
    		$(".btn-newsletter").addClass('d-none');
    		$(".thanks-newsletter").removeClass('d-none');
  		}).fail(function(error, status){
  			alert("Something went wrong!");
  		});
  	} else {
  		$('#alertICMailModal').modal();
  	}
  });
  
  $(".btn-newsletter-page").click(function() {
  	if(checkICMail($("#inputNewsletterPage").val())){
  		$.post("https://clayish-airfields.000webhostapp.com/newsletter.php", // TODO: Change link to server
  		{
   			mail: $("#inputNewsletterPage").val()
  		},
  		function(data, status){
    		$("#inputNewsletterPage").addClass('d-none');
    		$(".btn-newsletter-page").addClass('d-none');
    		$(".thanks-newsletter-page").removeClass('d-none');
  		}).fail(function(error, status){
  			alert("Something went wrong!");
  		});
  	} else {
  		$('#alertICMailModal').modal();
  	}
  });
});